\chapter{Projeto da rede de sensores e atuadores}\label{chp:redesensores}

\section{Protocolos de comunicação existentes}\label{sec:commprot}
O projeto de uma rede de sensores e atuadores sem fio deve levar em conta diversas restrições dos dispositivos que a compõem, tais como o acesso limitado a uma fonte de energia, capacidade reduzida de processamento e meio de comunicação com interferências. Com estas restrições em mente, diversos protocolos de comunicação foram propostos para viabilizar a implementação de redes de sensores sem fio, descritos a seguir.

\subsection{ZigBee}
O ZigBee é um protocolo de comunicação proposto e padronizado pela \textit{ZigBee Alliance} em 2003, visando aplicação em redes de sensores sem fio \cite{zigbeealliance}. A especificação do protocolo abrange diversos aspectos, desde os de natureza física (e.g., estratégias de redução de intereferência) às de natureza de aplicação (e.g., aplicação de criptografia sobre os dados transmitidos) \cite{stevanovic2007}. A Figura \ref{fig:zigbee} ilustra a abrangência do protocolo ZigBee, tendo como base um modelo em camadas de rede similar ao OSI.

\begin{figure}[h]
	\centering
	\caption{Abrangência da especificação do protocolo ZigBee, baseado em um modelo de camadas.}
  \includegraphics[width=0.8\textwidth]{imagens/zigbee.png}
  \label{fig:zigbee}
  
  Fonte: \cite{stevanovic2007}
\end{figure}

Como pode ser verificado no esquema, o ZigBee baseia-se na especificação IEEE 802.15.4 no que tange às camadas física e de controle de acesso ao meio (equivalente às camadas 1 e 2 do modelo OSI). O ZigBee define somente aspectos de alto nível que compõem as camadas de rede (camada 3) e de aplicação. Nos próximos parágrafos, será feita uma descrição do 802.15.4.

O protocolo IEEE 802.15.4 é um protocolo de camadas física e de enlace que busca prover comunicação com baixa complexidade para dispositivos com capacidades limitadas de transmissão de dados e de processamento \cite{ieee802_15}. A Tabela \ref{tab:802} resume as características deste protocolo.

\begin{table}[h]
	\centering
	\caption{Características do protocolo IEEE 802.15.4}\smallskip
	\label{tab:802}
	\tabulinesep = 4mm
	\begin{tabu}{|m{6cm}|m{7cm}|}
		\hline
		Frequências de operação e taxas de transferência & \parbox{5cm}{868 MHz: 20 kb/s\\915 MHz: 40 kb/s\\2,4 GHz: 250 kb/s} \\ \hline
		Canais &  \parbox{5cm}{868/915 MHz: 11 Canais \\ 2,4 GHz: 16 Canais} \\ \hline
		Endereçamento & 16 bits (modo curto) ou 64 bits \\ \hline
		Acesso ao meio & CSMA-CA \\
		\hline
	\end{tabu}
	
	\bigskip
	Fonte: \cite{stevanovic2007, schonwalder2010}
\end{table}
Como se pode notar, o protocolo opera em três faixas de frequência, sendo que a de 2,4 GHz provê maior número de canais e maior vazão de dados, além de estar licenciado para uso global, ao contrário das demais \cite{schonwalder2010}. Dentre as funções desempenhadas pelo 802.15.4, destacam-se o controle de acesso ao canal (baseado no CSMA-CA), a confirmação de entrega e checagem de erro em \textit{frames}.

O protocolo IEEE 802.15.4 ainda define dois tipos de dispositivos. Um dispositivo com funcionalidade completa (\textit{Full Function Device - FFD}) não possui restrições acentuadas de recursos, podendo se tornar um nó coordenador da rede de sensores. Ele pode efetuar diversas tarefas dentro da rede, tal como aceitar conexões e encaminhar pacotes. 

Um dispositivo com funcionalidade reduzida (\textit{Reduced Function Device - RFD}), por sua vez, consiste em um dispositivo periférico, tal como um sensor, possuindo restrições significativas de recursos. Estes dispositivos em geral atuam como "folhas" na topologia de rede, comunicando-se com um nó concentrador (um FFD) quando necessário.

Conforme mencionado, o ZigBee define recursos das camadas de rede e aplicação, como uma extensão ao protocolo 802.15.4 (ver Figura \ref{fig:zigbee}). Para tanto, são definidos três tipos de equipamentos dentro de uma rede ZigBee. Um dispositivo final consiste em um FFD ou RFD simples, que se comunica com um único nó. Um dispositivo roteador é um FFD capaz de reencaminhar mensagens  ao destinatário, caso necessário. Por fim, um dispositivo coordenador atua como coordenador da rede, possuindo também as funcionalidades de um roteador.

Pode-se derivar um recurso importante introduzido pela especificação do ZigBee: o roteamento \textit{multihop}, atuando como camada de rede. Isso significa que caso um dispositivo envie um pacote para outro esteja fora do seu alcance, basta que haja roteadores conectando-os. Além disso, o ZigBee permite a formação de redes em malha (\textit{mesh}), provendo confiabilidade e tolerância a falhas.

Por fim, o ZigBee introduz recursos importantes em nível de aplicação. Exemplos incluem a possibilidade de fragmentação e remontagem de pacotes, manutenção de um registro de dispositivos pareados e funcionalidades relacionadas à segurança, como criptografia.

\subsection{6LoWPAN}
O 6LoWPAN é um protocolo definido pelo IETF que define a utilização de IPv6 sobre redes sem fio de baixo consumo, de alcance pessoal (acrônimo do inglês \textit{IPv6 over Low-power Wireless Personal Area Network}) \cite{rfc4944}. O objetivo principal deste protocolo é integrar o protocolo IP em redes de baixo consumo, trazendo diversos benefícios, tais como \cite{rfc4919, schonwalder2010}
\begin{itemize}
	\item A possibilidade de se reutilizar a infraestrutura IP existente;
	\item A possibilidade de adotar tecnologias que trabalham sobre o protocolo IP, em geral amplamente conhecidos e aceitos por profissionais;
	\item A facilidade de interoperabilidade com redes IP existentes, e
	\item A adequação do esquema de endereçamento do IPv6, suprindo a necessidade de um grande número de endereços exigido em uma aplicação de IoT.
\end{itemize}

De modo semelhante ao ZigBee, o 6LoWPAN baseia-se no protocolo IEEE 802.15.4 no que tange às camadas física e de enlace, de modo a se adequar a redes de baixo consumo. No entanto,o 6LoWPAN define uma camada de interface entre as camadas do 802.15.4 e IP, como pode ser visto na Figura \ref{fig:6lowpan}.

\begin{figure}[h]
	\centering
	\caption{A especificação do protocolo 6LoWPAN e sua relação com os protocolos 802.15.4 e IP. O modelo OSI é mostrado ao lado como referência.}
  \includegraphics[width=0.8\textwidth]{imagens/6lowpan.png}
  \label{fig:6lowpan}
  
  Fonte: \cite{moreiras2009}
\end{figure}

A necessidade de uma camada de interface entre o IPv6 e as camadas inferiores padronizadas pelo 802.15.4 se dá por incompatibilidades existentes entre tais protocolos \cite{rfc4919}. Um exemplo diz respeito ao tamanho dos pacotes previstos por cada protocolo: o 802.15.4 prevê pacotes pequenos, com tamanhos de no máximo 81 bytes, ao passo que o IPv6 exige suporte a um MTU mínimo de 1280 bytes. Logo, um papel da interface definida pelo 6LoWPAN é o de efetuar fragmentação e montagem dos pacotes, a fim de compatibilizar os protocolos.
Outras funções do protocolo incluem:
\begin{itemize}
	\item Compressão de cabeçalho: como mencionado, o 802.15.11 suporta cabeçalhos de no máximo 81 bytes. Sendo que um cabeçalho IPv6 ocupa no mínimo 40 bytes (sem os cabeçalhos opcionais), restam somente 41 bytes para serem usados pelos protocolos de camadas superiores. Fica evidente, então, a necessidade de se aplicar técnicas de compressão de cabeçalho, função esta desempenhada pelo 6LoWPAN;
	\item Roteamento \textit{multi-hop} em redes \textit{mesh}: de modo semelhante ao ZigBee, o 6LoWPAN permite a configuração de redes \textit{mesh} com capacidade de  autorreparação, provendo robustez.
\end{itemize}

\subsection{Bluetooth}
Bluetooth é uma tecnologia de comunicação sem fio a curta distância. Opera em banda não licenciada ISM (Industrial, Científica e Médica, na sigla em inglês) entre 2,4Ghz e 2,485GHz.
Por não utilizar banda licenciada, o Bluetooth utiliza saltos adaptativos em frequência (\textit{Adaptative Frequency Hoping} - AFH) para diminuir a interferência com outros dispositivos operantes na mesma faixa de 2,4GHz. O aparelho toma conhecimento de demais dispositivos na mesma frequência e as evita, saltando entre 79 frequências a intervalos de 1MHz. 

A operação Bluetooth ocorre em redes Ad-Hoc de curto alcance conhecidas como Piconet. Tais redes podem ser constituídas por 1 membro mestre, 7 escravos ativos e 248 escravos estacionados (endereçamento de 8 bits). Cada dispositivo pode pertencer e várias Piconets. 
Seu raio de operação depende do dispositivo utilizado, que pode ser classificado em três categorias:
\begin{itemize}
        \item Classe 3: alcance de 1 metro e potência máxima de 1mW.
        \item Classe 2: alcance de 10 metros e potência máxima de 2,5mW.
        \item Classe 1: alcance de 100 metros, potência máxima de 100mW.
\end{itemize}

A camada mais baixa da arquitetura Bluetooth é a camada Física, na qual são definidas as especificações do dispositivo para operar. Dois dispositivos compartilham o mesmo meio físico e para se comunicarem devem estar sintonizados na mesma frequência (processo de parear). Para identificar os membros da Piconet, um código de acesso é sempre enviado no cabeçalho de cada pacote, aumentando a carga e inviabilizando para dispositivos de menor capacidade, como no caso deste projeto. 

Uma mesma unidade pode participar como escrava em várias Piconets mas atuar como mestre em apenas uma. Para participar de mais de uma Piconet o dispositivo atua com multiplexação no tempo (\textit{Time Division Multiplex} - TDM). O conjunto de várias Piconets independentes e não sincronizadas é chamado de Scatternet.

\begin{figure}[h]
	\centering
	\caption{Diagrama para rede Piconet e conjunto gerando Scatternet.}
  \includegraphics[width=0.8\textwidth]{imagens/redesbluetooth.png}
  \label{fig:redesbluetooth}
  
  Fonte: \cite{redesbluetooth}
\end{figure}

No acesso ao meio físico utiliza-se o método CDMA (\textit{Code Division Multiple Access}). Para o projeto da casa conectada, utilizaria-se o padrão de Enlace ACL (\textit{Asynchronous Conection-Less}), do tipo ponto-multiponto (um mestre e vários escravos). Este padrão é adequado para transmissão de dados, de modo que pacotes perdidos ou com erros são retransmitidos. 

Em qualquer rede sem fio, a vulnerabilidade das informações é evidente. Como o meio que propaga o sinal é o próprio ar, um dispositivo pode captar um sinal sendo enviado se este não for devidamente protegido. No caso da tecnologia Bluetooth, onde as conexões são feitas de forma automática, é especialmente importante definir formas de proteger os usuários para que não recebam dados de dispositivos que não desejam.

Para garantir a integridade das informações, aplicam-se modos de criptografia e autenticação. Isto é especialmente importante no projeto da casa conectada, no qual usuários externos e diferentes do dono do sistema não podem ter acesso. 

Para iniciar uma conexão, um pedido de permissão deve ser enviado. Os dispositivos Bluetooth usam uma chave de acesso chamada número de identificação pessoal (PIN) para autenticação. Se a chave de acesso digitada pelo usuário que deseja conectar corresponder à chave de acesso ao dispositivo detectado, a autenticação é realizada com êxito. Caso contrário ela falhará. 




\subsection{Z-Wave}
Z-Wave é um protocolo de comunicação sem fio que tem como foco baixo consumo, baixa taxa de dados e confiabilidade. Foi criado pela empresa dinamarquesa Zen-Sys, que foi adquirida pela Sigma Designs e desde sua concepção é voltada para automação residencial \cite{wikizwave,zwavelayers}.

As duas camadas mais baixas (Física e Enlace) da pilha de protocolos são definidas pelo ITU-T G.9959, ou seja, trata-se de um padrão formalmente definido por um órgão internacional de padrões. Porém, sua camada de rede é definida pela Sigma Designs e as camadas acima são definidas pelo desenvolvedor da aplicação, como pode ser observado na Figura \ref{fig:zwavelayers}.


\begin{figure}[h]
	\centering
	\caption{Pilha de protocolos do Z-Wave}
  \includegraphics[width=0.8\textwidth]{imagens/zwavelayers.jpg}
  \label{fig:zwavelayers}
  
    Fonte: \cite{zwavelayers}
\end{figure}

O Z-Wave trabalha em frequências abaixo de 1GHz, por volta de 900MHz, fazendo com que ela não interfira com Wi-Fi, Bluetooth e diversas outras tecnologias que trabalham na já bastante utilizada frequência de 2,4GHz. Além disso, suas taxas de transmissão são de 9600 bit/s, 40 kbit/s ou 100 kbit/s e seu alcance é de 100m em áreas abertas.

Uma rede Z-Wave define dois tipos de dispositivos: controladores e escravos. Os controladores iniciam comandos de controle para os escravos e os enviam. Já os nós escravos apenas respondem a comandos e os executam. Porém, estes nós também podem funcionar como repetidores, aumentando o alcance de sua rede Z-Wave.